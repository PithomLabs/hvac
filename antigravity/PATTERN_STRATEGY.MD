# PATTERN_STRATEGY.MD: Strategic Bug Resolution via PocketFlow Patterns

This document outlines how specific PocketFlow design patterns from the `cookbook` can be applied to resolve the remaining bugs in the HVAC Booking Agent.

---

## 1. Problem: Safety Blindness & Phase 2 Rigidity (BUG-001 / BUG_1.5)
The agent confirms the booking but ignores critical user safety questions during the same turn.

### **PROPOSED PATTERN: Thinking (Chain-of-Thought)**
Instead of a direct mapping from `Decide -> Chat`, we introduce a **Thinking** phase.
- **How it works**: Before `ChatNode` generates the final text, it performs an internal "Reasoning" step.
- **Implementation**: 
  - `ChatNode` (or a mid-node) asks: "Did the user ask a safety question? If yes, what is the answer? Now, combine that answer with the Booking Confirmation script."
  - This prevents the model from "tunnel-visioning" on the successful booking script.

---

## 2. Problem: Handover Leaks & Aggressive Replying (BUG-001 / BUG_1.3)
Internal `[SYSTEM]` messages leaking to the user or multi-turn logic running without user interaction.

### **PROPOSED PATTERN: Supervisor**
A **Supervisor Node** acts as a final gatekeeper for the `shared["last_response"]`.
- **How it works**: Every response generated by `ChatNode` or `BookingNode` must pass through the `Supervisor`.
- **Implementation**:
  - The Supervisor checks: "Is this message meant for a Human? Does it contain [SYSTEM] tags?"
  - If it's a system message, the Supervisor silences it (`shared["last_response"] = ""`) and ensures the flow exits to wait for user input.

---

## 3. Problem: Generic Technical Advice (Scenario 6, 14, 17)
The agent gives generic or repetitive advice for specific technical issues.

### **PROPOSED PATTERN: RAG (Retrieval-Augmented Generation)**
Use **RAG** to inject high-quality, verified safety/technical instructions into the context.
- **How it works**: Instead of the LLM guessing what to do for a "Burning Smell," we retrieve the "Emergency Safety Protocol" document.
- **Implementation**:
  - `ExtractionNode` identifies the `issue_type`.
  - A `RetrieveAdviceNode` pulls relevant chunks from `data/knowledge_base/hvac_safety.txt` (to be created).
  - This advice is then passed to `ChatNode` as a mandatory inclusion.

---

## 4. Implementation Timeline (Refinement 6-10)

| Turn | Target Pattern | Objective |
| :--- | :--- | :--- |
| **Step 1** | **Supervisor** | Map `decide - "finish" >> Supervisor` to fix Graph Warnings and Leaks. |
| **Step 2** | **Thinking** | Update `ChatNode` to evaluate "Safety First" before script delivery. |
| **Step 3** | **RAG** | (Optional / Future) Add knowledge base for Scenario 17+ reliability. |

---
*Created by Antigravity on 2026-01-02*
