Project Structure:
├── (Advanced) Multi-Agents _ Pocket Flow.html (Size: 32.85kb; Lines: 148)
├── Agent _ Pocket Flow.html (Size: 27.29kb; Lines: 103)
├── Map Reduce _ Pocket Flow.html (Size: 20.87kb; Lines: 47)
├── RAG _ Pocket Flow.html (Size: 30.61kb; Lines: 114)
├── Structured Output _ Pocket Flow.html (Size: 20.49kb; Lines: 48)
└── Workflow _ Pocket Flow.html (Size: 19.56kb; Lines: 28)

---
(Advanced) Multi-Agents _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(6)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(6) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(6) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(6) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>(Advanced) Multi-Agents | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="(Advanced) Multi-Agents" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/multi_agent.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/multi_agent.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="(Advanced) Multi-Agents" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"(Advanced) Multi-Agents","url":"https://the-pocket.github.io/PocketFlow/design_pattern/multi_agent.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>(Advanced) Multi-Agents</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="advanced-multi-agents"> <a href="#advanced-multi-agents" class="anchor-heading" aria-labelledby="advanced-multi-agents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> (Advanced) Multi-Agents </h1> <p>Multiple <a href="./flow.md">Agents</a> can work together by handling subtasks and communicating the progress. Communication between agents is typically implemented using message queues in shared storage.</p> <blockquote class="best-practice"> <p>Most of time, you don’t need Multi-Agents. Start with a simple solution first.</p> </blockquote> <h3 id="example-agent-communication-message-queue"> <a href="#example-agent-communication-message-queue" class="anchor-heading" aria-labelledby="example-agent-communication-message-queue"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Agent Communication: Message Queue </h3> <p>Here’s a simple example showing how to implement agent communication using <code class="language-plaintext highlighter-rouge">asyncio.Queue</code>. The agent listens for messages, processes them, and continues listening:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AgentNode</span><span class="p">(</span><span class="n">AsyncNode</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">prep_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">message_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="s">"messages"</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message_queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent received: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>

<span class="c1"># Create node and flow
</span><span class="n">agent</span> <span class="o">=</span> <span class="n">AgentNode</span><span class="p">()</span>
<span class="n">agent</span> <span class="o">&gt;&gt;</span> <span class="n">agent</span>  <span class="c1"># connect to self
</span><span class="n">flow</span> <span class="o">=</span> <span class="n">AsyncFlow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span>

<span class="c1"># Create heartbeat sender
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">send_system_messages</span><span class="p">(</span><span class="n">message_queue</span><span class="p">):</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"System status: all systems operational"</span><span class="p">,</span>
        <span class="s">"Memory usage: normal"</span><span class="p">,</span>
        <span class="s">"Network connectivity: stable"</span><span class="p">,</span>
        <span class="s">"Processing load: optimal"</span>
    <span class="p">]</span>
    
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">messages</span><span class="p">[</span><span class="n">counter</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)]</span><span class="si">}</span><span class="s"> | timestamp_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s">"</span>
        <span class="k">await</span> <span class="n">message_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">message_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">flow</span><span class="p">.</span><span class="n">set_params</span><span class="p">({</span><span class="s">"messages"</span><span class="p">:</span> <span class="n">message_queue</span><span class="p">})</span>
    
    <span class="c1"># Run both coroutines
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">flow</span><span class="p">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">shared</span><span class="p">),</span>
        <span class="n">send_system_messages</span><span class="p">(</span><span class="n">message_queue</span><span class="p">)</span>
    <span class="p">)</span>
    
<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div> <p>The output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Agent received: System status: all systems operational | timestamp_0
Agent received: Memory usage: normal | timestamp_1
Agent received: Network connectivity: stable | timestamp_2
Agent received: Processing load: optimal | timestamp_3
</code></pre></div></div> <h3 id="interactive-multi-agent-example-taboo-game"> <a href="#interactive-multi-agent-example-taboo-game" class="anchor-heading" aria-labelledby="interactive-multi-agent-example-taboo-game"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Interactive Multi-Agent Example: Taboo Game </h3> <p>Here’s a more complex example where two agents play the word-guessing game Taboo. One agent provides hints while avoiding forbidden words, and another agent tries to guess the target word:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AsyncHinter</span><span class="p">(</span><span class="n">AsyncNode</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">prep_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"hinter_queue"</span><span class="p">].</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="o">==</span> <span class="s">"GAME_OVER"</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"target_word"</span><span class="p">],</span> <span class="n">shared</span><span class="p">[</span><span class="s">"forbidden_words"</span><span class="p">],</span> <span class="n">shared</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"past_guesses"</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">forbidden</span><span class="p">,</span> <span class="n">past_guesses</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Generate hint for '</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s">'</span><span class="se">\n</span><span class="s">Forbidden words: </span><span class="si">{</span><span class="n">forbidden</span><span class="si">}</span><span class="s">"</span>
        <span class="k">if</span> <span class="n">past_guesses</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Previous wrong guesses: </span><span class="si">{</span><span class="n">past_guesses</span><span class="si">}</span><span class="se">\n</span><span class="s">Make hint more specific."</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\n</span><span class="s">Use at most 5 words."</span>
        
        <span class="n">hint</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Hinter: Here's your hint - </span><span class="si">{</span><span class="n">hint</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hint</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">post_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exec_res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"end"</span>
        <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"guesser_queue"</span><span class="p">].</span><span class="n">put</span><span class="p">(</span><span class="n">exec_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"continue"</span>

<span class="k">class</span> <span class="nc">AsyncGuesser</span><span class="p">(</span><span class="n">AsyncNode</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">prep_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="n">hint</span> <span class="o">=</span> <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"guesser_queue"</span><span class="p">].</span><span class="n">get</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hint</span><span class="p">,</span> <span class="n">shared</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"past_guesses"</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">hint</span><span class="p">,</span> <span class="n">past_guesses</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Given hint: </span><span class="si">{</span><span class="n">hint</span><span class="si">}</span><span class="s">, past wrong guesses: </span><span class="si">{</span><span class="n">past_guesses</span><span class="si">}</span><span class="s">, make a new guess. Directly reply a single word:"</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Guesser: I guess it's - </span><span class="si">{</span><span class="n">guess</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">guess</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">post_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exec_res</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">shared</span><span class="p">[</span><span class="s">"target_word"</span><span class="p">].</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Game Over - Correct guess!"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"hinter_queue"</span><span class="p">].</span><span class="n">put</span><span class="p">(</span><span class="s">"GAME_OVER"</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">"end"</span>
            
        <span class="k">if</span> <span class="s">"past_guesses"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared</span><span class="p">:</span>
            <span class="n">shared</span><span class="p">[</span><span class="s">"past_guesses"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"past_guesses"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">exec_res</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"hinter_queue"</span><span class="p">].</span><span class="n">put</span><span class="p">(</span><span class="n">exec_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"continue"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Set up game
</span>    <span class="n">shared</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"target_word"</span><span class="p">:</span> <span class="s">"nostalgia"</span><span class="p">,</span>
        <span class="s">"forbidden_words"</span><span class="p">:</span> <span class="p">[</span><span class="s">"memory"</span><span class="p">,</span> <span class="s">"past"</span><span class="p">,</span> <span class="s">"remember"</span><span class="p">,</span> <span class="s">"feeling"</span><span class="p">,</span> <span class="s">"longing"</span><span class="p">],</span>
        <span class="s">"hinter_queue"</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">(),</span>
        <span class="s">"guesser_queue"</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"Game starting!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Target word: </span><span class="si">{</span><span class="n">shared</span><span class="p">[</span><span class="s">'target_word'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Forbidden words: </span><span class="si">{</span><span class="n">shared</span><span class="p">[</span><span class="s">'forbidden_words'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="c1"># Initialize by sending empty guess to hinter
</span>    <span class="k">await</span> <span class="n">shared</span><span class="p">[</span><span class="s">"hinter_queue"</span><span class="p">].</span><span class="n">put</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

    <span class="c1"># Create nodes and flows
</span>    <span class="n">hinter</span> <span class="o">=</span> <span class="n">AsyncHinter</span><span class="p">()</span>
    <span class="n">guesser</span> <span class="o">=</span> <span class="n">AsyncGuesser</span><span class="p">()</span>

    <span class="c1"># Set up flows
</span>    <span class="n">hinter_flow</span> <span class="o">=</span> <span class="n">AsyncFlow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">hinter</span><span class="p">)</span>
    <span class="n">guesser_flow</span> <span class="o">=</span> <span class="n">AsyncFlow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">guesser</span><span class="p">)</span>

    <span class="c1"># Connect nodes to themselves
</span>    <span class="n">hinter</span> <span class="o">-</span> <span class="s">"continue"</span> <span class="o">&gt;&gt;</span> <span class="n">hinter</span>
    <span class="n">guesser</span> <span class="o">-</span> <span class="s">"continue"</span> <span class="o">&gt;&gt;</span> <span class="n">guesser</span>

    <span class="c1"># Run both agents concurrently
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">hinter_flow</span><span class="p">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">shared</span><span class="p">),</span>
        <span class="n">guesser_flow</span><span class="p">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></div> <p>The Output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Game starting!
Target word: nostalgia
Forbidden words: ['memory', 'past', 'remember', 'feeling', 'longing']

Hinter: Here's your hint - Thinking of childhood summer days
Guesser: I guess it's - popsicle

Hinter: Here's your hint - When childhood cartoons make you emotional
Guesser: I guess it's - nostalgic

Hinter: Here's your hint - When old songs move you
Guesser: I guess it's - memories

Hinter: Here's your hint - That warm emotion about childhood
Guesser: I guess it's - nostalgia
Game Over - Correct guess!
</code></pre></div></div> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>

---
Agent _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Agent | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Agent" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/agent.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/agent.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Agent" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"Agent","url":"https://the-pocket.github.io/PocketFlow/design_pattern/agent.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>Agent</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="agent"> <a href="#agent" class="anchor-heading" aria-labelledby="agent"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Agent </h1> <p>Agent is a powerful design pattern in which nodes can take dynamic actions based on the context.</p> <div align="center"> <img src="https://github.com/the-pocket/.github/raw/main/assets/agent.png?raw=true" width="350" /> </div> <h2 id="implement-agent-with-graph"> <a href="#implement-agent-with-graph" class="anchor-heading" aria-labelledby="implement-agent-with-graph"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implement Agent with Graph </h2> <ol> <li><strong>Context and Action:</strong> Implement nodes that supply context and perform actions.</li> <li><strong>Branching:</strong> Use branching to connect each action node to an agent node. Use action to allow the agent to direct the <a href="/PocketFlow/core_abstraction/flow.html">flow</a> between nodes—and potentially loop back for multi-step.</li> <li><strong>Agent Node:</strong> Provide a prompt to decide action—for example:</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sa">f</span><span class="s">"""
### CONTEXT
Task: </span><span class="si">{</span><span class="n">task_description</span><span class="si">}</span><span class="s">
Previous Actions: </span><span class="si">{</span><span class="n">previous_actions</span><span class="si">}</span><span class="s">
Current State: </span><span class="si">{</span><span class="n">current_state</span><span class="si">}</span><span class="s">

### ACTION SPACE
[1] search
  Description: Use web search to get results
  Parameters:
    - query (str): What to search for

[2] answer
  Description: Conclude based on the results
  Parameters:
    - result (str): Final answer to provide

### NEXT ACTION
Decide the next action based on the current context and available action space.
Return your response in the following format:

```yaml
thinking: |
    &lt;your step-by-step reasoning process&gt;
action: &lt;action_name&gt;
parameters:
    &lt;parameter_name&gt;: &lt;parameter_value&gt;
```"""</span>
</code></pre></div></div> <p>The core of building <strong>high-performance</strong> and <strong>reliable</strong> agents boils down to:</p> <ol> <li> <p><strong>Context Management:</strong> Provide <em>relevant, minimal context.</em> For example, rather than including an entire chat history, retrieve the most relevant via <a href="/PocketFlow/design_pattern/rag.html">RAG</a>. Even with larger context windows, LLMs still fall victim to <a href="https://arxiv.org/abs/2307.03172">“lost in the middle”</a>, overlooking mid-prompt content.</p> </li> <li> <p><strong>Action Space:</strong> Provide <em>a well-structured and unambiguous</em> set of actions—avoiding overlap like separate <code class="language-plaintext highlighter-rouge">read_databases</code> or <code class="language-plaintext highlighter-rouge">read_csvs</code>. Instead, import CSVs into the database.</p> </li> </ol> <h2 id="example-good-action-design"> <a href="#example-good-action-design" class="anchor-heading" aria-labelledby="example-good-action-design"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Good Action Design </h2> <ul> <li> <p><strong>Incremental:</strong> Feed content in manageable chunks (500 lines or 1 page) instead of all at once.</p> </li> <li> <p><strong>Overview-zoom-in:</strong> First provide high-level structure (table of contents, summary), then allow drilling into details (raw texts).</p> </li> <li> <p><strong>Parameterized/Programmable:</strong> Instead of fixed actions, enable parameterized (columns to select) or programmable (SQL queries) actions, for example, to read CSV files.</p> </li> <li> <p><strong>Backtracking:</strong> Let the agent undo the last step instead of restarting entirely, preserving progress when encountering errors or dead ends.</p> </li> </ul> <h2 id="example-search-agent"> <a href="#example-search-agent" class="anchor-heading" aria-labelledby="example-search-agent"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example: Search Agent </h2> <p>This agent:</p> <ol> <li>Decides whether to search or answer</li> <li>If searches, loops back to decide if more search needed</li> <li>Answers when enough context gathered</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DecideAction</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">shared</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"context"</span><span class="p">,</span> <span class="s">"No previous search"</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="s">"query"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span>
        
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""
Given input: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s">
Previous search results: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s">
Should I: 1) Search web for more info 2) Answer with current knowledge
Output in yaml:
```yaml
action: search/answer
reason: why this action
search_term: search phrase if action is search
```"""</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">yaml_str</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"```yaml"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"```"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_str</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">"action"</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="k">assert</span> <span class="s">"reason"</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"search"</span><span class="p">,</span> <span class="s">"answer"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"search"</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s">"search_term"</span> <span class="ow">in</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"search"</span><span class="p">:</span>
            <span class="n">shared</span><span class="p">[</span><span class="s">"search_term"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"search_term"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">exec_res</span><span class="p">[</span><span class="s">"action"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">SearchWeb</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"search_term"</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_term</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">search_web</span><span class="p">(</span><span class="n">search_term</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
        <span class="n">prev_searches</span> <span class="o">=</span> <span class="n">shared</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"context"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"context"</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_searches</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">{</span><span class="s">"term"</span><span class="p">:</span> <span class="n">shared</span><span class="p">[</span><span class="s">"search_term"</span><span class="p">],</span> <span class="s">"result"</span><span class="p">:</span> <span class="n">exec_res</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s">"decide"</span>
        
<span class="k">class</span> <span class="nc">DirectAnswer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"query"</span><span class="p">],</span> <span class="n">shared</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"context"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s">Answer: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span>
       <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Answer: </span><span class="si">{</span><span class="n">exec_res</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
       <span class="n">shared</span><span class="p">[</span><span class="s">"answer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span>

<span class="c1"># Connect nodes
</span><span class="n">decide</span> <span class="o">=</span> <span class="n">DecideAction</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">SearchWeb</span><span class="p">()</span>
<span class="n">answer</span> <span class="o">=</span> <span class="n">DirectAnswer</span><span class="p">()</span>

<span class="n">decide</span> <span class="o">-</span> <span class="s">"search"</span> <span class="o">&gt;&gt;</span> <span class="n">search</span>
<span class="n">decide</span> <span class="o">-</span> <span class="s">"answer"</span> <span class="o">&gt;&gt;</span> <span class="n">answer</span>
<span class="n">search</span> <span class="o">-</span> <span class="s">"decide"</span> <span class="o">&gt;&gt;</span> <span class="n">decide</span>  <span class="c1"># Loop back
</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">decide</span><span class="p">)</span>
<span class="n">flow</span><span class="p">.</span><span class="n">run</span><span class="p">({</span><span class="s">"query"</span><span class="p">:</span> <span class="s">"Who won the Nobel Prize in Physics 2024?"</span><span class="p">})</span>
</code></pre></div></div> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>

---
Map Reduce _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(4)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(4) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(4) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(4) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Map Reduce | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Map Reduce" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/mapreduce.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/mapreduce.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Map Reduce" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"Map Reduce","url":"https://the-pocket.github.io/PocketFlow/design_pattern/mapreduce.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>Map Reduce</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="map-reduce"> <a href="#map-reduce" class="anchor-heading" aria-labelledby="map-reduce"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Map Reduce </h1> <p>MapReduce is a design pattern suitable when you have either:</p> <ul> <li>Large input data (e.g., multiple files to process), or</li> <li>Large output data (e.g., multiple forms to fill)</li> </ul> <p>and there is a logical way to break the task into smaller, ideally independent parts.</p> <div align="center"> <img src="https://github.com/the-pocket/.github/raw/main/assets/mapreduce.png?raw=true" width="400" /> </div> <p>You first break down the task using <a href="/PocketFlow/core_abstraction/batch.html">BatchNode</a> in the map phase, followed by aggregation in the reduce phase.</p> <h3 id="example-document-summarization"> <a href="#example-document-summarization" class="anchor-heading" aria-labelledby="example-document-summarization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example: Document Summarization </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SummarizeAllFiles</span><span class="p">(</span><span class="n">BatchNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="n">files_dict</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="s">"files"</span><span class="p">]</span>  <span class="c1"># e.g. 10 files
</span>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">files_dict</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>  <span class="c1"># [("file1.txt", "aaa..."), ("file2.txt", "bbb..."), ...]
</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">one_file</span><span class="p">):</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">file_content</span> <span class="o">=</span> <span class="n">one_file</span>
        <span class="n">summary_text</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Summarize the following file:</span><span class="se">\n</span><span class="si">{</span><span class="n">file_content</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">summary_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res_list</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"file_summaries"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">exec_res_list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CombineSummaries</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"file_summaries"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_summaries</span><span class="p">):</span>
        <span class="c1"># format as: "File1: summary\nFile2: summary...\n"
</span>        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">summ</span> <span class="ow">in</span> <span class="n">file_summaries</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">text_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s"> summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summ</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">big_text</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">---</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Combine these file summaries into one final summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">big_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">final_summary</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"all_files_summary"</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_summary</span>

<span class="n">batch_node</span> <span class="o">=</span> <span class="n">SummarizeAllFiles</span><span class="p">()</span>
<span class="n">combine_node</span> <span class="o">=</span> <span class="n">CombineSummaries</span><span class="p">()</span>
<span class="n">batch_node</span> <span class="o">&gt;&gt;</span> <span class="n">combine_node</span>

<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">batch_node</span><span class="p">)</span>

<span class="n">shared</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"files"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"file1.txt"</span><span class="p">:</span> <span class="s">"Alice was beginning to get very tired of sitting by her sister..."</span><span class="p">,</span>
        <span class="s">"file2.txt"</span><span class="p">:</span> <span class="s">"Some other interesting text ..."</span><span class="p">,</span>
        <span class="c1"># ...
</span>    <span class="p">}</span>
<span class="p">}</span>
<span class="n">flow</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Individual Summaries:"</span><span class="p">,</span> <span class="n">shared</span><span class="p">[</span><span class="s">"file_summaries"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Final Summary:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shared</span><span class="p">[</span><span class="s">"all_files_summary"</span><span class="p">])</span>
</code></pre></div></div> <blockquote class="note"> <p><strong>Performance Tip</strong>: The example above works sequentially. You can speed up the map phase by running it in parallel. See <a href="/PocketFlow/core_abstraction/parallel.html">(Advanced) Parallel</a> for more details.</p> </blockquote> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>

---
RAG _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(3)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(3) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(3) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>RAG | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="RAG" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/rag.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/rag.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="RAG" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"RAG","url":"https://the-pocket.github.io/PocketFlow/design_pattern/rag.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>RAG</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="rag-retrieval-augmented-generation"> <a href="#rag-retrieval-augmented-generation" class="anchor-heading" aria-labelledby="rag-retrieval-augmented-generation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> RAG (Retrieval Augmented Generation) </h1> <p>For certain LLM tasks like answering questions, providing relevant context is essential. One common architecture is a <strong>two-stage</strong> RAG pipeline:</p> <div align="center"> <img src="https://github.com/the-pocket/.github/raw/main/assets/rag.png?raw=true" width="400" /> </div> <ol> <li><strong>Offline stage</strong>: Preprocess and index documents (“building the index”).</li> <li><strong>Online stage</strong>: Given a question, generate answers by retrieving the most relevant context.</li> </ol><hr /> <h2 id="stage-1-offline-indexing"> <a href="#stage-1-offline-indexing" class="anchor-heading" aria-labelledby="stage-1-offline-indexing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Stage 1: Offline Indexing </h2> <p>We create three Nodes:</p> <ol> <li><code class="language-plaintext highlighter-rouge">ChunkDocs</code> – <a href="/PocketFlow/utility_function/chunking.html">chunks</a> raw text.</li> <li><code class="language-plaintext highlighter-rouge">EmbedDocs</code> – <a href="/PocketFlow/utility_function/embedding.html">embeds</a> each chunk.</li> <li><code class="language-plaintext highlighter-rouge">StoreIndex</code> – stores embeddings into a <a href="/PocketFlow/utility_function/vector.html">vector database</a>.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ChunkDocs</span><span class="p">(</span><span class="n">BatchNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="c1"># A list of file paths in shared["files"]. We process each file.
</span>        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"files"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="c1"># read file content. In real usage, do error handling.
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># chunk by 100 chars each
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">chunks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">size</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">chunks</span>
    
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res_list</span><span class="p">):</span>
        <span class="c1"># exec_res_list is a list of chunk-lists, one per file.
</span>        <span class="c1"># flatten them all into a single list of chunks.
</span>        <span class="n">all_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chunk_list</span> <span class="ow">in</span> <span class="n">exec_res_list</span><span class="p">:</span>
            <span class="n">all_chunks</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">)</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"all_chunks"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_chunks</span>

<span class="k">class</span> <span class="nc">EmbedDocs</span><span class="p">(</span><span class="n">BatchNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"all_chunks"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_embedding</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res_list</span><span class="p">):</span>
        <span class="c1"># Store the list of embeddings.
</span>        <span class="n">shared</span><span class="p">[</span><span class="s">"all_embeds"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res_list</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total embeddings: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exec_res_list</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StoreIndex</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="c1"># We'll read all embeds from shared.
</span>        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"all_embeds"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_embeds</span><span class="p">):</span>
        <span class="c1"># Create a vector index (faiss or other DB in real usage).
</span>        <span class="n">index</span> <span class="o">=</span> <span class="n">create_index</span><span class="p">(</span><span class="n">all_embeds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"index"</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

<span class="c1"># Wire them in sequence
</span><span class="n">chunk_node</span> <span class="o">=</span> <span class="n">ChunkDocs</span><span class="p">()</span>
<span class="n">embed_node</span> <span class="o">=</span> <span class="n">EmbedDocs</span><span class="p">()</span>
<span class="n">store_node</span> <span class="o">=</span> <span class="n">StoreIndex</span><span class="p">()</span>

<span class="n">chunk_node</span> <span class="o">&gt;&gt;</span> <span class="n">embed_node</span> <span class="o">&gt;&gt;</span> <span class="n">store_node</span>

<span class="n">OfflineFlow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">chunk_node</span><span class="p">)</span>
</code></pre></div></div> <p>Usage example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"files"</span><span class="p">:</span> <span class="p">[</span><span class="s">"doc1.txt"</span><span class="p">,</span> <span class="s">"doc2.txt"</span><span class="p">],</span>  <span class="c1"># any text files
</span><span class="p">}</span>
<span class="n">OfflineFlow</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
</code></pre></div></div><hr /> <h2 id="stage-2-online-query--answer"> <a href="#stage-2-online-query--answer" class="anchor-heading" aria-labelledby="stage-2-online-query--answer"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Stage 2: Online Query &amp; Answer </h2> <p>We have 3 nodes:</p> <ol> <li><code class="language-plaintext highlighter-rouge">EmbedQuery</code> – embeds the user’s question.</li> <li><code class="language-plaintext highlighter-rouge">RetrieveDocs</code> – retrieves top chunk from the index.</li> <li><code class="language-plaintext highlighter-rouge">GenerateAnswer</code> – calls the LLM with the question + chunk to produce the final answer.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EmbedQuery</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"question"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_embedding</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">q_emb</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"q_emb"</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_emb</span>

<span class="k">class</span> <span class="nc">RetrieveDocs</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="c1"># We'll need the query embedding, plus the offline index/chunks
</span>        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"q_emb"</span><span class="p">],</span> <span class="n">shared</span><span class="p">[</span><span class="s">"index"</span><span class="p">],</span> <span class="n">shared</span><span class="p">[</span><span class="s">"all_chunks"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">q_emb</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">I</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">search_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">q_emb</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">best_id</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">relevant_chunk</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">best_id</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">relevant_chunk</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">relevant_chunk</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"retrieved_chunk"</span><span class="p">]</span> <span class="o">=</span> <span class="n">relevant_chunk</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Retrieved chunk:"</span><span class="p">,</span> <span class="n">relevant_chunk</span><span class="p">[:</span><span class="mi">60</span><span class="p">],</span> <span class="s">"..."</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GenerateAnswer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"question"</span><span class="p">],</span> <span class="n">shared</span><span class="p">[</span><span class="s">"retrieved_chunk"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">question</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Question: </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s">Context: </span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="se">\n</span><span class="s">Answer:"</span>
        <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
        <span class="n">shared</span><span class="p">[</span><span class="s">"answer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Answer:"</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

<span class="n">embed_qnode</span> <span class="o">=</span> <span class="n">EmbedQuery</span><span class="p">()</span>
<span class="n">retrieve_node</span> <span class="o">=</span> <span class="n">RetrieveDocs</span><span class="p">()</span>
<span class="n">generate_node</span> <span class="o">=</span> <span class="n">GenerateAnswer</span><span class="p">()</span>

<span class="n">embed_qnode</span> <span class="o">&gt;&gt;</span> <span class="n">retrieve_node</span> <span class="o">&gt;&gt;</span> <span class="n">generate_node</span>
<span class="n">OnlineFlow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">embed_qnode</span><span class="p">)</span>
</code></pre></div></div> <p>Usage example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Suppose we already ran OfflineFlow and have:
# shared["all_chunks"], shared["index"], etc.
</span><span class="n">shared</span><span class="p">[</span><span class="s">"question"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Why do people like cats?"</span>

<span class="n">OnlineFlow</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
<span class="c1"># final answer in shared["answer"]
</span></code></pre></div></div> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>

---
Structured Output _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Structured Output | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Structured Output" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/structure.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/structure.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Structured Output" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"Structured Output","url":"https://the-pocket.github.io/PocketFlow/design_pattern/structure.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>Structured Output</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="structured-output"> <a href="#structured-output" class="anchor-heading" aria-labelledby="structured-output"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Structured Output </h1> <p>In many use cases, you may want the LLM to output a specific structure, such as a list or a dictionary with predefined keys.</p> <p>There are several approaches to achieve a structured output:</p> <ul> <li><strong>Prompting</strong> the LLM to strictly return a defined structure.</li> <li>Using LLMs that natively support <strong>schema enforcement</strong>.</li> <li><strong>Post-processing</strong> the LLM’s response to extract structured content.</li> </ul> <p>In practice, <strong>Prompting</strong> is simple and reliable for modern LLMs.</p> <h3 id="example-use-cases"> <a href="#example-use-cases" class="anchor-heading" aria-labelledby="example-use-cases"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Use Cases </h3> <ul> <li>Extracting Key Information</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">product</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Widget Pro</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">199.99</span>
  <span class="na">description</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">A high-quality widget designed for professionals.</span>
    <span class="s">Recommended for advanced users.</span>
</code></pre></div></div> <ul> <li>Summarizing Documents into Bullet Points</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">summary</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">This product is easy to use.</span>
  <span class="pi">-</span> <span class="s">It is cost-effective.</span>
  <span class="pi">-</span> <span class="s">Suitable for all skill levels.</span>
</code></pre></div></div> <ul> <li>Generating Configuration Files</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">server</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">ssl</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div> <h2 id="prompt-engineering"> <a href="#prompt-engineering" class="anchor-heading" aria-labelledby="prompt-engineering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prompt Engineering </h2> <p>When prompting the LLM to produce <strong>structured</strong> output:</p> <ol> <li><strong>Wrap</strong> the structure in code fences (e.g., <code class="language-plaintext highlighter-rouge">yaml</code>).</li> <li><strong>Validate</strong> that all required fields exist (and let <code class="language-plaintext highlighter-rouge">Node</code> handles retry).</li> </ol> <h3 id="example-text-summarization"> <a href="#example-text-summarization" class="anchor-heading" aria-labelledby="example-text-summarization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Text Summarization </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SummarizeNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">):</span>
        <span class="c1"># Suppose `prep_res` is the text to summarize.
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""
Please summarize the following text as YAML, with exactly 3 bullet points

</span><span class="si">{</span><span class="n">prep_res</span><span class="si">}</span><span class="s">

Now, output:
```yaml
summary:
  - bullet 1
  - bullet 2
  - bullet 3
```"""</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">yaml_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"```yaml"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"```"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>

        <span class="kn">import</span> <span class="nn">yaml</span>
        <span class="n">structured_result</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_str</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s">"summary"</span> <span class="ow">in</span> <span class="n">structured_result</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structured_result</span><span class="p">[</span><span class="s">"summary"</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">structured_result</span>
</code></pre></div></div> <blockquote class="note"> <p>Besides using <code class="language-plaintext highlighter-rouge">assert</code> statements, another popular way to validate schemas is <a href="https://github.com/pydantic/pydantic">Pydantic</a></p> </blockquote> <h3 id="why-yaml-instead-of-json"> <a href="#why-yaml-instead-of-json" class="anchor-heading" aria-labelledby="why-yaml-instead-of-json"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why YAML instead of JSON? </h3> <p>Current LLMs struggle with escaping. YAML is easier with strings since they don’t always need quotes.</p> <p><strong>In JSON</strong></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dialogue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alice said: </span><span class="se">\"</span><span class="s2">Hello Bob.</span><span class="se">\\</span><span class="s2">nHow are you?</span><span class="se">\\</span><span class="s2">nI am good.</span><span class="se">\"</span><span class="s2">"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li>Every double quote inside the string must be escaped with <code class="language-plaintext highlighter-rouge">\"</code>.</li> <li>Each newline in the dialogue must be represented as <code class="language-plaintext highlighter-rouge">\n</code>.</li> </ul> <p><strong>In YAML</strong></p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dialogue</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">Alice said: "Hello Bob.</span>
  <span class="s">How are you?</span>
  <span class="s">I am good."</span>
</code></pre></div></div> <ul> <li>No need to escape interior quotes—just place the entire text under a block literal (<code class="language-plaintext highlighter-rouge">|</code>).</li> <li>Newlines are naturally preserved without needing <code class="language-plaintext highlighter-rouge">\n</code>.</li> </ul> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>

---
Workflow _ Pocket Flow.html
---
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/PocketFlow/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(2)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list { display: block; } </style> <script src="/PocketFlow/assets/js/vendor/lunr.min.js"></script> <script src="/PocketFlow/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Workflow | Pocket Flow</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Workflow" /> <meta name="author" content="Zachary Huang" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <meta property="og:description" content="Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves" /> <link rel="canonical" href="https://the-pocket.github.io/PocketFlow/design_pattern/workflow.html" /> <meta property="og:url" content="https://the-pocket.github.io/PocketFlow/design_pattern/workflow.html" /> <meta property="og:site_name" content="Pocket Flow" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Workflow" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zachary Huang","url":"https://www.columbia.edu/~zh2408/"},"description":"Pocket Flow – Minimalist LLM Framework in 100 Lines, Enabling LLMs to Program Themselves","headline":"Workflow","url":"https://the-pocket.github.io/PocketFlow/design_pattern/workflow.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/PocketFlow/" class="site-title lh-tight"> Pocket Flow </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/" class="nav-list-link">Home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Core Abstraction category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/core_abstraction/" class="nav-list-link">Core Abstraction</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/node.html" class="nav-list-link">Node</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/flow.html" class="nav-list-link">Flow</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/communication.html" class="nav-list-link">Communication</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/batch.html" class="nav-list-link">Batch</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/async.html" class="nav-list-link">(Advanced) Async</a></li><li class="nav-list-item"><a href="/PocketFlow/core_abstraction/parallel.html" class="nav-list-link">(Advanced) Parallel</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Design Pattern category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/design_pattern/" class="nav-list-link">Design Pattern</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/design_pattern/agent.html" class="nav-list-link">Agent</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/workflow.html" class="nav-list-link">Workflow</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/rag.html" class="nav-list-link">RAG</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/mapreduce.html" class="nav-list-link">Map Reduce</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/structure.html" class="nav-list-link">Structured Output</a></li><li class="nav-list-item"><a href="/PocketFlow/design_pattern/multi_agent.html" class="nav-list-link">(Advanced) Multi-Agents</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Utility Function category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/PocketFlow/utility_function/" class="nav-list-link">Utility Function</a><ul class="nav-list"><li class="nav-list-item"><a href="/PocketFlow/utility_function/llm.html" class="nav-list-link">LLM Wrapper</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/viz.html" class="nav-list-link">Viz and Debug</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/websearch.html" class="nav-list-link">Web Search</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/chunking.html" class="nav-list-link">Text Chunking</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/embedding.html" class="nav-list-link">Embedding</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/vector.html" class="nav-list-link">Vector Databases</a></li><li class="nav-list-item"><a href="/PocketFlow/utility_function/text_to_speech.html" class="nav-list-link">Text-to-Speech</a></li></ul></li><li class="nav-list-item"><a href="/PocketFlow/guide.html" class="nav-list-link">Agentic Coding</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Pocket Flow" aria-label="Search Pocket Flow" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/the-pocket/PocketFlow" class="site-button" > View on GitHub </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/PocketFlow/design_pattern/">Design Pattern</a></li> <li class="breadcrumb-nav-list-item"><span>Workflow</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 id="workflow"> <a href="#workflow" class="anchor-heading" aria-labelledby="workflow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Workflow </h1> <p>Many real-world tasks are too complex for one LLM call. The solution is to <strong>Task Decomposition</strong>: decompose them into a <a href="/PocketFlow/core_abstraction/flow.html">chain</a> of multiple Nodes.</p> <div align="center"> <img src="https://github.com/the-pocket/.github/raw/main/assets/workflow.png?raw=true" width="400" /> </div> <blockquote class="best-practice"> <ul> <li>You don’t want to make each task <strong>too coarse</strong>, because it may be <em>too complex for one LLM call</em>.</li> <li>You don’t want to make each task <strong>too granular</strong>, because then <em>the LLM call doesn’t have enough context</em> and results are <em>not consistent across nodes</em>.</li> </ul> <p>You usually need multiple <em>iterations</em> to find the <em>sweet spot</em>. If the task has too many <em>edge cases</em>, consider using <a href="/PocketFlow/design_pattern/agent.html">Agents</a>.</p> </blockquote> <h3 id="example-article-writing"> <a href="#example-article-writing" class="anchor-heading" aria-labelledby="example-article-writing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example: Article Writing </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GenerateOutline</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"topic"</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span> <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Create a detailed outline for an article about </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span> <span class="n">shared</span><span class="p">[</span><span class="s">"outline"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span>

<span class="k">class</span> <span class="nc">WriteSection</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"outline"</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outline</span><span class="p">):</span> <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Write content based on this outline: </span><span class="si">{</span><span class="n">outline</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span> <span class="n">shared</span><span class="p">[</span><span class="s">"draft"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span>

<span class="k">class</span> <span class="nc">ReviewAndRefine</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">):</span> <span class="k">return</span> <span class="n">shared</span><span class="p">[</span><span class="s">"draft"</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">draft</span><span class="p">):</span> <span class="k">return</span> <span class="n">call_llm</span><span class="p">(</span><span class="sa">f</span><span class="s">"Review and improve this draft: </span><span class="si">{</span><span class="n">draft</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared</span><span class="p">,</span> <span class="n">prep_res</span><span class="p">,</span> <span class="n">exec_res</span><span class="p">):</span> <span class="n">shared</span><span class="p">[</span><span class="s">"final_article"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_res</span>

<span class="c1"># Connect nodes
</span><span class="n">outline</span> <span class="o">=</span> <span class="n">GenerateOutline</span><span class="p">()</span>
<span class="n">write</span> <span class="o">=</span> <span class="n">WriteSection</span><span class="p">()</span>
<span class="n">review</span> <span class="o">=</span> <span class="n">ReviewAndRefine</span><span class="p">()</span>

<span class="n">outline</span> <span class="o">&gt;&gt;</span> <span class="n">write</span> <span class="o">&gt;&gt;</span> <span class="n">review</span>

<span class="c1"># Create and run flow
</span><span class="n">writing_flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">outline</span><span class="p">)</span>
<span class="n">shared</span> <span class="o">=</span> <span class="p">{</span><span class="s">"topic"</span><span class="p">:</span> <span class="s">"AI Safety"</span><span class="p">}</span>
<span class="n">writing_flow</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>
</code></pre></div></div> <p>For <em>dynamic cases</em>, consider using <a href="/PocketFlow/design_pattern/agent.html">Agents</a>.</p> </main> <hr> <footer> <!-- PocketFlow Chatbot - Start --> <script> (function() { var script = document.createElement("script"); script.src = "https://askthispage.com/embed/chatbot.js"; script.onload = function() { initializeChatbot({ extra_urls: ["https://github.com/The-Pocket/PocketFlow/blob/main/.cursorrules"], prefixes: ["https://github.com/The-Pocket","https://the-pocket.github.io/"], chatbotName: 'PocketFlow Website Chatbot', wsUrl: 'wss://askthispage.com/api/ws/chat', instruction: '', isOpen: false }); }; document.head.appendChild(script); })(); </script> <!-- PocketFlow Chatbot - End --> </footer> </div> </div> <div class="search-overlay"></div> </div> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.3/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script> </body> </html>